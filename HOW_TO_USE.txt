================================================================================
                    VAULTCTL - HOW TO USE GUIDE
================================================================================

vaultctl is a zero-knowledge CLI password manager with client-side encryption.
All encryption and decryption happens locally. The server (DynamoDB) only
stores encrypted blobs and never sees your master password or decrypted data.

================================================================================
                            INSTALLATION
================================================================================

1. PREREQUISITES
   - Go 1.23 or later installed
   - AWS CLI configured (for DynamoDB access)
   - AWS account with DynamoDB access

2. BUILD THE APPLICATION

   OPTION A: Manual Build
   cd /path/to/emerald-blossom-dreamstone
   go mod download
   go build -o vaultctl

   This creates an executable named "vaultctl" in the current directory.

   OPTION B: Using run.sh Script (Recommended)
   The project includes a convenient run.sh script that automates building
   and running the application.

   First, make the script executable:
   chmod +x run.sh

   Then use it to build:
   ./run.sh build

   The script will:
   - Check prerequisites (Go, AWS CLI)
   - Download dependencies
   - Build the application
   - Provide colored status messages

   You can also use it to run commands directly:
   ./run.sh run init
   ./run.sh run add --name github --username user@example.com
   ./run.sh run list

   For more information about run.sh:
   ./run.sh help

3. INSTALL (OPTIONAL)
   You can move the vaultctl binary to a directory in your PATH:
   sudo mv vaultctl /usr/local/bin/
   
   Or install via Go:
   go install

================================================================================
                            INITIAL SETUP
================================================================================

STEP 1: CREATE DYNAMODB TABLE

Create a DynamoDB table in your AWS account:

Table name: vaultctl_vaults
Partition key: PK (String)
Sort key: SK (String)

You can create this via:
- AWS Console: https://console.aws.amazon.com/dynamodb
- AWS CLI: 
  aws dynamodb create-table \
    --table-name vaultctl_vaults \
    --attribute-definitions AttributeName=PK,AttributeType=S AttributeName=SK,AttributeType=S \
    --key-schema AttributeName=PK,KeyType=HASH AttributeName=SK,KeyType=RANGE \
    --billing-mode PAY_PER_REQUEST

STEP 2: CONFIGURE AWS CREDENTIALS

Choose one of these methods:

A) AWS CLI Configuration:
   aws configure
   Enter your AWS Access Key ID, Secret Access Key, region, and output format

B) Environment Variables:
   export AWS_ACCESS_KEY_ID=your_access_key
   export AWS_SECRET_ACCESS_KEY=your_secret_key
   export AWS_DEFAULT_REGION=us-east-1

C) IAM Role (if running on EC2):
   Attach an IAM role with DynamoDB permissions to your EC2 instance

STEP 3: SET UP IAM PERMISSIONS

Your AWS user/role needs these DynamoDB permissions:
- dynamodb:GetItem
- dynamodb:PutItem

Minimum IAM policy:
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "dynamodb:GetItem",
        "dynamodb:PutItem"
      ],
      "Resource": "arn:aws:dynamodb:*:*:table/vaultctl_vaults"
    }
  ]
}

STEP 4: INITIALIZE YOUR VAULT

Run the init command:
  ./run.sh run init
  Or: vaultctl init

You will be prompted to:
  1. Enter a master password (this encrypts your vault)
  2. Confirm the master password

IMPORTANT: Remember your master password! If you lose it, you cannot
recover your vault. The master password is never stored anywhere.

After initialization, your vault is created locally at:
  ~/.vaultctl/vault.db

And synced to DynamoDB (if configured).

Note: If using run.sh for the first time, it will automatically build
the application before running the init command.

================================================================================
                            BASIC USAGE
================================================================================

You can use vaultctl in two ways:
1. Using the run.sh script: ./run.sh run [command]
2. Directly: vaultctl [command] (after building)

Both methods work the same way. The run.sh script is convenient because it
automatically builds the application if needed.

UNLOCK THE VAULT

Before using most commands, you need to unlock the vault:
  ./run.sh run unlock
  Or: vaultctl unlock

Enter your master password when prompted. The vault stays unlocked for the
duration of your terminal session (30 minutes by default).

SESSION-BASED UNLOCKING

vaultctl uses session-based unlocking, which means you only need to enter
your master password ONCE per terminal session. After unlocking:

- All subsequent commands (add, get, list, remove, etc.) work automatically
- No password prompt needed for 30 minutes
- Session persists across different terminal windows in the same session
- Session expires after 30 minutes of inactivity

How it works:
1. First command: Run `vaultctl unlock` and enter master password
2. Session created: Vault key is encrypted and stored in ~/.vaultctl/session.json
3. Subsequent commands: Automatically use the session (no password needed)
4. Session expires: After 30 minutes, you'll be prompted for password again

LOCK THE VAULT

To manually lock the vault and clear the session:
  ./run.sh run lock
  Or: vaultctl lock

This clears the session and requires you to unlock again for the next command.

Note: Some commands (like add, get, list) will automatically prompt you to
unlock if the vault is locked or the session has expired.

ADD A PASSWORD ENTRY

Add a new password entry:
  ./run.sh run add --name github --username user@example.com --url https://github.com/login --notes "2FA enabled"
  Or: vaultctl add --name github --username user@example.com --url https://github.com/login --notes "2FA enabled"

Flags:
  --name     (required) Name/identifier for the entry
  --username (optional) Username or email
  --url      (optional) Website URL
  --notes    (optional) Additional notes
  --no-sync  (optional) Don't sync to DynamoDB after adding

The password will be prompted securely (hidden input).

Example:
  ./run.sh run add --name "Work Email" --username "john@company.com"
  Or: vaultctl add --name "Work Email" --username "john@company.com"
  Enter password: [hidden]

GET A PASSWORD ENTRY

Retrieve a password entry by name or ID:
  ./run.sh run get github
  ./run.sh run get <entry-id>
  Or: vaultctl get github
  Or: vaultctl get <entry-id>

This displays all information for the entry including the password.

LIST ALL ENTRIES

List all entries without showing passwords:
  ./run.sh run list
  Or: vaultctl list

Output shows: Name, Username, URL, Last Updated

REMOVE AN ENTRY

Delete an entry:
  ./run.sh run remove github
  ./run.sh run remove <entry-id>
  Or: vaultctl remove github
  Or: vaultctl remove <entry-id>

Flags:
  --no-sync  (optional) Don't sync to DynamoDB after removing

SYNC WITH DYNAMODB

Sync your local vault with the remote DynamoDB vault:
  ./run.sh run sync
  Or: vaultctl sync

This will:
- Pull the latest version from DynamoDB if it's newer
- Push your local changes if they're newer
- Handle version conflicts

If there's a conflict, you'll be prompted to resolve it.

CREATE A BACKUP

Create an encrypted backup of your vault:
  ./run.sh run backup
  Or: vaultctl backup

This creates a backup file at:
  ~/.vaultctl/backups/vault-YYYY-MM-DDTHH-MM-SSZ.enc

Or specify a custom path:
  ./run.sh run backup /path/to/backup.enc
  Or: vaultctl backup /path/to/backup.enc

The backup is encrypted with the same encryption as your vault.

ROTATE MASTER PASSWORD

Change your master password:
  ./run.sh run rotate-master
  Or: vaultctl rotate-master

You will be prompted to:
  1. Enter your current master password
  2. Enter your new master password
  3. Confirm your new master password

This re-encrypts your vault key with the new master password. Your
entries remain unchanged.

================================================================================
                            CONFIGURATION
================================================================================

Configuration is stored at: ~/.vaultctl/config.json

Default configuration:
{
  "aws_region": "us-east-1",
  "table_name": "vaultctl_vaults",
  "user_id": "default",
  "vault_path": "~/.vaultctl/vault.db"
}

You can edit this file directly to change:
- AWS region
- DynamoDB table name
- User ID (for multi-user scenarios)
- Local vault file path

The config file is created automatically on first use.

================================================================================
                            EXAMPLES
================================================================================

EXAMPLE 1: Complete Workflow (Using run.sh)

1. Build the application:
   ./run.sh build
   [INFO] Checking prerequisites...
   [SUCCESS] Go is installed (version: 1.24.3)
   [SUCCESS] AWS CLI is installed
   [SUCCESS] vaultctl built successfully!

2. Initialize vault:
   ./run.sh run init
   Enter master password: ********
   Confirm master password: ********
   Vault initialized and synced to DynamoDB

3. Unlock the vault (only needed once per session):
   ./run.sh run unlock
   Enter master password: ********
   Vault unlocked successfully

4. Add entries (no password prompt needed - using session):
   ./run.sh run add --name "Gmail" --username "me@gmail.com" --url "https://gmail.com"
   Enter password: ********  (this is the entry password, not master password)
   Entry 'Gmail' added successfully

   ./run.sh run add --name "GitHub" --username "developer" --url "https://github.com"
   Enter password: ********  (entry password)
   Entry 'GitHub' added successfully

5. List entries (no password needed):
   ./run.sh run list
   NAME    USERNAME    URL                  UPDATED
   Gmail   me@gmail.com https://gmail.com    2025-01-16 10:30:00
   GitHub  developer   https://github.com    2025-01-16 10:31:00

6. Get an entry (no password needed):
   ./run.sh run get Gmail
   Name: Gmail
   Username: me@gmail.com
   Password: mypassword123
   URL: https://gmail.com
   Created: 2025-01-16 10:30:00
   Updated: 2025-01-16 10:30:00

7. Sync with remote (no password needed):
   ./run.sh run sync
   Vault synced successfully (version 3)

Note: After unlocking once, all subsequent commands work without prompting
for the master password for 30 minutes. The session persists across commands.

ALTERNATIVE: Using vaultctl directly (after building)

If you've already built vaultctl, you can use it directly:

1. Initialize vault:
   vaultctl init
   Enter master password: ********
   Confirm master password: ********
   Vault initialized and synced to DynamoDB

2. Unlock the vault (only needed once per session):
   vaultctl unlock
   Enter master password: ********
   Vault unlocked successfully

3. Add entries (no master password prompt - using session):
   vaultctl add --name "Gmail" --username "me@gmail.com" --url "https://gmail.com"
   Enter password: ********  (entry password, not master password)
   Entry 'Gmail' added successfully

4. List entries (no password needed):
   vaultctl list
   NAME    USERNAME    URL                  UPDATED
   Gmail   me@gmail.com https://gmail.com    2025-01-16 10:30:00

5. Get an entry (no password needed):
   vaultctl get Gmail
   Name: Gmail
   Username: me@gmail.com
   Password: mypassword123
   URL: https://gmail.com
   Created: 2025-01-16 10:30:00
   Updated: 2025-01-16 10:30:00

6. Sync with remote (no password needed):
   vaultctl sync
   Vault synced successfully (version 3)

7. Lock the vault when done:
   vaultctl lock
   Vault locked successfully

EXAMPLE 2: Working Offline

If DynamoDB is not available, you can still use vaultctl locally:

1. Unlock vault (only once per session):
   ./run.sh run unlock
   Enter master password: ********
   Vault unlocked successfully

   Or if using vaultctl directly:
   vaultctl unlock
   Enter master password: ********
   Vault unlocked successfully

2. Add entries (no master password needed - session active):
   ./run.sh run add --name "Local Entry" --no-sync
   Enter password: ********  (entry password only)
   
   Or:
   vaultctl add --name "Local Entry" --no-sync
   Enter password: ********  (entry password only)

3. When DynamoDB is available again (no password needed):
   ./run.sh run sync
   
   Or:
   vaultctl sync

EXAMPLE 3: Backup and Restore

1. Create backup:
   ./run.sh run backup
   Backup created at: ~/.vaultctl/backups/vault-2025-01-16T10-00-00Z.enc

   Or:
   vaultctl backup
   Backup created at: ~/.vaultctl/backups/vault-2025-01-16T10-00-00Z.enc

2. To restore from backup:
   - Copy the backup file to your vault location
   - Or use it as a reference (it's encrypted, so you still need master password)

EXAMPLE 4: Using run.sh Features

1. Check if everything is set up correctly:
   ./run.sh
   This will check prerequisites, build if needed, and show vaultctl help

2. Build and run in one command:
   ./run.sh build-and-run init
   This builds the application and immediately runs the init command

3. Clean build artifacts:
   ./run.sh clean
   Removes the vaultctl binary (useful for a fresh build)

EXAMPLE 5: Session Management

1. Unlock once at the start of your work session:
   vaultctl unlock
   Enter master password: ********
   Vault unlocked successfully

2. Work with multiple commands (no password prompts):
   vaultctl add --name "Work Email" --username "user@company.com"
   vaultctl list
   vaultctl get "Work Email"
   vaultctl remove "Old Entry"
   # All work without master password prompts!

3. After 30 minutes, session expires:
   vaultctl list
   Enter master password: ********  (session expired, need to unlock again)

4. Manually lock when done:
   vaultctl lock
   Vault locked successfully
   # Next command will require unlock

================================================================================
                            TROUBLESHOOTING
================================================================================

PROBLEM: "DynamoDB not available" warning

SOLUTION:
- Check AWS credentials are configured: aws configure list
- Verify AWS region matches your DynamoDB table region
- Ensure DynamoDB table exists and is accessible
- Check IAM permissions include dynamodb:GetItem and dynamodb:PutItem

Note: The vault works locally even without DynamoDB. You just won't have
cloud sync until DynamoDB is configured.

PROBLEM: "version conflict" error

SOLUTION:
- Run: vaultctl sync
- This will sync your local vault with the remote version
- If conflicts persist, you may need to manually resolve by choosing
  which version to keep

PROBLEM: "vault not found" error

SOLUTION:
- Run: vaultctl init
- This creates a new vault
- If you had an existing vault, check the vault_path in config.json

PROBLEM: "failed to unlock vault" error

SOLUTION:
- Verify you're using the correct master password
- Check that the vault file exists at the configured path
- Ensure you have read permissions on the vault file
- If vault is corrupted, restore from backup

PROBLEM: "failed to decrypt" error

SOLUTION:
- Verify master password is correct
- Check that vault file is not corrupted
- Try restoring from a backup if available
- Ensure you're using the same vault file that was encrypted
- If using session, try clearing it: vaultctl lock, then unlock again

PROBLEM: "session expired" or "no active session" error

SOLUTION:
- This is normal after 30 minutes of inactivity
- Simply run: vaultctl unlock
- Enter your master password to create a new session
- Sessions expire for security - this is expected behavior

PROBLEM: Session not persisting across commands

SOLUTION:
- Ensure you're in the same terminal session (same shell)
- Check that ~/.vaultctl/session.json exists and has correct permissions
- Verify VAULTCTL_SESSION_KEY environment variable is set
- Try unlocking again: vaultctl unlock

PROBLEM: Command not found

SOLUTION:
- Ensure vaultctl is in your PATH, or
- Use full path: /path/to/vaultctl [command]
- Or run from the build directory: ./vaultctl [command]

================================================================================
                            SECURITY BEST PRACTICES
================================================================================

1. MASTER PASSWORD
   - Use a strong, unique master password
   - Consider using a passphrase (multiple words)
   - Never share your master password
   - Store it securely (password manager, physical safe, etc.)

2. VAULT FILE
   - The vault file is encrypted, but still protect it
   - Don't share the vault file
   - Regular backups are recommended
   - Store backups in secure locations

3. AWS CREDENTIALS
   - Use IAM roles when possible (more secure than access keys)
   - Rotate access keys regularly
   - Use least-privilege IAM policies
   - Never commit AWS credentials to version control

4. ENVIRONMENT
   - Run vaultctl on trusted machines only
   - Be cautious when using on shared systems
   - Clear terminal history if passwords were displayed
   - Lock your screen when not using the terminal
   - Use `vaultctl lock` when finished working to clear the session
   - Sessions expire after 30 minutes for security

5. BACKUPS
   - Create regular backups: vaultctl backup
   - Store backups in multiple secure locations
   - Test backup restoration periodically
   - Encrypt backup storage if storing in cloud

================================================================================
                            FILE LOCATIONS
================================================================================

Default file locations (on Unix-like systems):

Configuration:
  ~/.vaultctl/config.json

Vault file:
  ~/.vaultctl/vault.db

Session file:
  ~/.vaultctl/session.json
  (Contains encrypted session data - automatically managed)

Backups:
  ~/.vaultctl/backups/vault-*.enc

On Windows, replace ~ with %USERPROFILE%

================================================================================
                            ADVANCED USAGE
================================================================================

CUSTOM TABLE NAME

If you want to use a different DynamoDB table:

1. Edit ~/.vaultctl/config.json:
   {
     "table_name": "my_custom_table"
   }

2. Or create the table with your custom name in DynamoDB

MULTI-USER SCENARIOS

For multiple users sharing the same DynamoDB table:

1. Set different user_id in config.json for each user:
   {
     "user_id": "user1"
   }

2. Each user's vault will be stored separately in DynamoDB with:
   PK: USER#user1
   SK: VAULT

OFFLINE MODE

vaultctl works completely offline. DynamoDB is optional for:
- Multi-device sync
- Cloud backup
- Remote access

All operations work locally without DynamoDB.

SESSION MANAGEMENT

vaultctl uses session-based unlocking for convenience:
- Unlock once: Enter master password when you start working
- Work freely: All commands work without password prompts for 30 minutes
- Auto-expire: Session expires after 30 minutes of inactivity
- Manual lock: Use `vaultctl lock` to end session early
- Secure: Session key stored in environment variable, vault key encrypted on disk

Session file location: ~/.vaultctl/session.json
Session timeout: 30 minutes (default)
Environment variable: VAULTCTL_SESSION_KEY (automatically set)

================================================================================
                            COMMAND REFERENCE
================================================================================

USING RUN.SH SCRIPT

The run.sh script provides a convenient way to build and run vaultctl:

./run.sh build
  Build the application (checks prerequisites, downloads deps, compiles)

./run.sh run [command] [args...]
  Run vaultctl with the specified command and arguments
  Example: ./run.sh run init
  Example: ./run.sh run add --name github --username user@example.com

./run.sh build-and-run [command] [args...]
  Build the application and then run it with the specified command
  Example: ./run.sh build-and-run list

./run.sh clean
  Remove build artifacts (the vaultctl binary)

./run.sh help
  Show run.sh usage information

./run.sh
  If no command is specified, checks prerequisites, builds if needed,
  and shows vaultctl help

DIRECT VAULTCTL COMMANDS

Once built, you can run vaultctl directly:

vaultctl init
  Initialize a new vault

vaultctl unlock
  Unlock the vault with master password (creates a 30-minute session)

vaultctl lock
  Lock the vault and clear the session

vaultctl add [flags]
  Add a new password entry
  Flags: --name, --username, --url, --notes, --no-sync

vaultctl get <name_or_id>
  Get a password entry by name or ID

vaultctl list
  List all entries (without passwords)

vaultctl remove <name_or_id> [flags]
  Remove an entry by name or ID
  Flags: --no-sync

vaultctl sync
  Sync vault with DynamoDB

vaultctl backup [output_path]
  Create an encrypted backup

vaultctl rotate-master
  Change the master password

vaultctl --help
  Show help for vaultctl

vaultctl [command] --help
  Show help for a specific command

================================================================================
                            SUPPORT
================================================================================

For issues, questions, or contributions:
- Check the README.md file
- Review the DESIGNDOC.md for architecture details
- Ensure all prerequisites are met
- Verify AWS configuration

Remember: This is a zero-knowledge password manager. If you lose your
master password, your vault cannot be recovered. Always maintain backups!

================================================================================
                            END OF GUIDE
================================================================================

